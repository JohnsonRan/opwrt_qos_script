#!/bin/sh
# OpenWrt Pure fq_codel Gaming QoS - 完整管理脚本
# 集成配置、检查、监控功能

WAN_IF="eth1"
UPLOAD_MBPS=50    # 实际上传速度
DOWNLOAD_MBPS=100 # 实际下载速度

# fq_codel 能很好处理缓冲区膨胀，可以设置更接近实际速度
UPLOAD_KBPS=$((UPLOAD_MBPS * 900))
DOWNLOAD_KBPS=$((DOWNLOAD_MBPS * 950))

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 启用QoS功能
start_qos() {
    echo "启用fq_codel QoS: $WAN_IF 上传${UPLOAD_KBPS}kbps 下载${DOWNLOAD_KBPS}kbps"

    # 清理现有配置
    tc qdisc del dev $WAN_IF root 2>/dev/null
    tc qdisc del dev $WAN_IF ingress 2>/dev/null
    tc qdisc del dev ifb0 root 2>/dev/null
    ip link del ifb0 2>/dev/null

    # 配置上传队列 - 低延迟游戏优化
    tc qdisc add dev $WAN_IF root handle 1: tbf rate ${UPLOAD_KBPS}kbit latency 80ms burst 40k
    tc qdisc add dev $WAN_IF parent 1: fq_codel target 2ms interval 50ms flows 1024 quantum 300 ecn

    # 配置下载队列 - 游戏优先低延迟
    modprobe ifb
    ip link add name ifb0 type ifb 2>/dev/null
    ip link set dev ifb0 up
    tc qdisc add dev $WAN_IF ingress
    tc filter add dev $WAN_IF parent ffff: protocol all u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0
    tc qdisc add dev ifb0 root handle 1: tbf rate ${DOWNLOAD_KBPS}kbit latency 80ms burst 50k
    tc qdisc add dev ifb0 parent 1: fq_codel target 2ms interval 50ms flows 1024 quantum 300 ecn

    echo "QoS配置完成"
}

# 停止QoS功能
stop_qos() {
    echo "正在停止QoS..."
    tc qdisc del dev $WAN_IF root 2>/dev/null
    tc qdisc del dev $WAN_IF ingress 2>/dev/null
    tc qdisc del dev ifb0 root 2>/dev/null
    ip link del ifb0 2>/dev/null
    echo "QoS已停止"
}

# 重置统计数据
reset_stats() {
    echo "正在重置QoS统计数据..."
    
    # 保存当前配置参数
    local upload_rate=$(tc qdisc show dev $WAN_IF | grep "qdisc tbf" | grep -o "rate [^ ]*" | cut -d' ' -f2)
    local download_rate=""
    
    if ip link show ifb0 >/dev/null 2>&1; then
        download_rate=$(tc qdisc show dev ifb0 | grep "qdisc tbf" | grep -o "rate [^ ]*" | cut -d' ' -f2)
    fi
    
    # 如果有配置，则重新应用以清除统计
    if [ -n "$upload_rate" ] && [ -n "$download_rate" ]; then
        echo "检测到现有配置，重新应用以清除统计数据..."
        stop_qos
        sleep 1
        start_qos
        echo "统计数据已重置"
    else
        echo "未检测到QoS配置，无需重置"
    fi
}

# 快速状态检查
check_qos() {
    printf "QoS 状态检查 - $(date '+%H:%M:%S')\n"
    printf "========================================\n"

    # 检查上传队列
    echo "【上传队列 - $WAN_IF】"
    upload_stats=$(tc -s qdisc show dev $WAN_IF | grep -A 3 "qdisc tbf")
    if [ -n "$upload_stats" ]; then
        rate=$(echo "$upload_stats" | grep "rate" | grep -o "rate [^b]*" | cut -d' ' -f2)
        dropped=$(echo "$upload_stats" | grep "dropped" | grep -o "dropped [0-9]*" | cut -d' ' -f2)
        overlimits=$(echo "$upload_stats" | grep "overlimits" | grep -o "overlimits [0-9]*" | cut -d' ' -f2)
        
        printf "  速率限制: %s\n" "$rate"
        printf "  丢包: %s | 超限: %s\n" "${dropped:-0}" "${overlimits:-0}"
        
        if [ "${dropped:-0}" -gt 100 ] || [ "${overlimits:-0}" -gt 1000 ]; then
            printf "  状态: ⚠️  需要关注\n"
        else
            printf "  状态: ✅ 正常\n"
        fi
    else
        printf "  状态: ❌ 未配置\n"
    fi

    echo ""

    # 检查下载队列
    echo "【下载队列 - ifb0】"
    if ip link show ifb0 >/dev/null 2>&1; then
        download_stats=$(tc -s qdisc show dev ifb0 | grep -A 3 "qdisc tbf")
        if [ -n "$download_stats" ]; then
            rate=$(echo "$download_stats" | grep "rate" | grep -o "rate [^b]*" | cut -d' ' -f2)
            dropped=$(echo "$download_stats" | grep "dropped" | grep -o "dropped [0-9]*" | cut -d' ' -f2)
            overlimits=$(echo "$download_stats" | grep "overlimits" | grep -o "overlimits [0-9]*" | cut -d' ' -f2)
            backlog=$(echo "$download_stats" | grep "backlog" | grep -o "backlog [0-9]*b" | cut -d' ' -f2 | sed 's/b//')
            
            printf "  速率限制: %s\n" "$rate"
            printf "  丢包: %s | 超限: %s | 积压: %s字节\n" "${dropped:-0}" "${overlimits:-0}" "${backlog:-0}"
            
            if [ "${dropped:-0}" -gt 1000 ] || [ "${overlimits:-0}" -gt 10000 ] || [ "${backlog:-0}" -gt 50000 ]; then
                printf "  状态: ⚠️  需要调整\n"
            else
                printf "  状态: ✅ 正常\n"
            fi
        else
            printf "  状态: ❌ 未配置\n"
        fi
    else
        printf "  状态: ❌ ifb0 接口不存在\n"
    fi
}

# 清屏函数
clear_screen() {
    printf '\033[2J\033[H'
}

# 格式化字节数
format_bytes() {
    local bytes=$1
    if [ $bytes -gt 1073741824 ]; then
        printf "%.2fGB" $(echo "scale=2; $bytes/1073741824" | bc)
    elif [ $bytes -gt 1048576 ]; then
        printf "%.2fMB" $(echo "scale=2; $bytes/1048576" | bc)
    elif [ $bytes -gt 1024 ]; then
        printf "%.2fKB" $(echo "scale=2; $bytes/1024" | bc)
    else
        printf "%dB" $bytes
    fi
}

# 格式化速率
format_rate() {
    local rate=$1
    if echo "$rate" | grep -q "Mbit"; then
        echo "$rate" | sed 's/Mbit/Mbps/'
    elif echo "$rate" | grep -q "Kbit"; then
        echo "$rate" | sed 's/Kbit/Kbps/'
    else
        echo "$rate"
    fi
}

# 判断状态颜色
get_status_color() {
    local dropped=$1
    local overlimits=$2
    local backlog=$3
    
    if [ $dropped -gt 1000 ] || [ $overlimits -gt 10000 ] || [ $backlog -gt 50000 ]; then
        echo "$RED"
    elif [ $dropped -gt 100 ] || [ $overlimits -gt 1000 ] || [ $backlog -gt 10000 ]; then
        echo "$YELLOW"
    else
        echo "$GREEN"
    fi
}

# 获取QoS统计信息
get_qos_stats() {
    local interface=$1
    local direction=$2
    
    # 获取TBF统计
    local tbf_stats=$(tc -s qdisc show dev $interface | grep -A 3 "qdisc tbf")
    local fq_stats=$(tc -s qdisc show dev $interface | grep -A 5 "qdisc fq_codel")
    
    if [ -z "$tbf_stats" ]; then
        echo "${RED}未找到 $direction 队列配置${NC}"
        return
    fi
    
    # 提取关键数据
    local rate=$(echo "$tbf_stats" | grep "qdisc tbf" | grep -o "rate [^ ]*" | cut -d' ' -f2)
    local sent_bytes=$(echo "$tbf_stats" | grep "Sent" | grep -o "Sent [0-9]*" | cut -d' ' -f2)
    local sent_packets=$(echo "$tbf_stats" | grep "Sent" | grep -o "[0-9]* pkt" | cut -d' ' -f1)
    local dropped=$(echo "$tbf_stats" | grep "dropped" | grep -o "dropped [0-9]*" | cut -d' ' -f2)
    local overlimits=$(echo "$tbf_stats" | grep "overlimits" | grep -o "overlimits [0-9]*" | cut -d' ' -f2)
    local backlog_bytes=$(echo "$tbf_stats" | grep "backlog" | grep -o "backlog [0-9]*b" | cut -d' ' -f2 | sed 's/b//')
    local backlog_packets=$(echo "$tbf_stats" | grep "backlog" | grep -o "[0-9]*p" | sed 's/p//')
    
    # FQ_CODEL 特定信息
    local fq_dropped=$(echo "$fq_stats" | grep "Sent" | grep -o "dropped [0-9]*" | cut -d' ' -f2)
    local new_flows=$(echo "$fq_stats" | grep "new_flow_count" | grep -o "new_flow_count [0-9]*" | cut -d' ' -f2)
    local memory_used=$(echo "$fq_stats" | grep "memory_used" | grep -o "memory_used [0-9]*" | cut -d' ' -f2)
    
    # 默认值处理
    [ -z "$dropped" ] && dropped=0
    [ -z "$overlimits" ] && overlimits=0
    [ -z "$backlog_bytes" ] && backlog_bytes=0
    [ -z "$backlog_packets" ] && backlog_packets=0
    [ -z "$fq_dropped" ] && fq_dropped=0
    [ -z "$new_flows" ] && new_flows=0
    [ -z "$memory_used" ] && memory_used=0
    
    # 状态判断
    local status_color=$(get_status_color $dropped $overlimits $backlog_bytes)
    
    printf "${BLUE}══════════════════════════════════════════════════════════════${NC}\n"
    printf "${BLUE}  %s 方向流量控制状态${NC}\n" "$direction"
    printf "${BLUE}══════════════════════════════════════════════════════════════${NC}\n"
    printf "  限制速率: ${YELLOW}%s${NC}\n" "$(format_rate $rate)"
    printf "  总流量:   ${GREEN}%s${NC} (%s 包)\n" "$(format_bytes $sent_bytes)" "$sent_packets"
    printf "  丢包数:   ${status_color}%s${NC}\n" "$dropped"
    printf "  超限次数: ${status_color}%s${NC}\n" "$overlimits"
    printf "  队列积压: ${status_color}%s (%s 包)${NC}\n" "$(format_bytes $backlog_bytes)" "$backlog_packets"
    
    if [ ! -z "$new_flows" ] && [ "$new_flows" != "0" ]; then
        printf "  新流计数: ${GREEN}%s${NC}\n" "$new_flows"
    fi
    
    if [ ! -z "$memory_used" ] && [ "$memory_used" != "0" ]; then
        printf "  内存使用: ${GREEN}%s${NC}\n" "$(format_bytes $memory_used)"
    fi
    
    # 状态评估
    printf "  状态评估: "
    if [ $dropped -gt 1000 ] || [ $overlimits -gt 10000 ]; then
        printf "${RED}需要调整 - 丢包/超限过多${NC}\n"
    elif [ $backlog_bytes -gt 50000 ]; then
        printf "${YELLOW}轻微拥塞 - 队列积压较多${NC}\n"
    else
        printf "${GREEN}运行良好${NC}\n"
    fi
    printf "\n"
}

# 主监控循环
main_monitor() {
    # 检查是否需要重置统计数据
    if [ "$2" = "reset" ] || [ "$2" = "clean" ]; then
        echo "准备开始监控，正在重置统计数据..."
        reset_stats
        sleep 2
    else
        echo "启动监控模式（保留历史数据）..."
        echo "提示: 使用 '$0 monitor reset' 可重置统计数据后监控"
        sleep 1
    fi
    
    while true; do
        clear_screen
        
        printf "${GREEN}╔════════════════════════════════════════════════════════════════╗${NC}\n"
        printf "${GREEN}║                    QoS 流量控制实时监控                        ║${NC}\n"
        printf "${GREEN}║                   $(date '+%Y-%m-%d %H:%M:%S')                   ║${NC}\n"
        printf "${GREEN}╚════════════════════════════════════════════════════════════════╝${NC}\n\n"
        
        # 检查QoS是否启用
        if ! tc qdisc show dev $WAN_IF | grep -q "qdisc tbf"; then
            printf "${RED}❌ QoS 未启用或配置错误${NC}\n"
            printf "${YELLOW}请先运行 $0 start 启用QoS${NC}\n"
            exit 1
        fi
        
        # 显示上传统计
        get_qos_stats $WAN_IF "上传"
        
        # 显示下载统计
        if ip link show ifb0 >/dev/null 2>&1; then
            get_qos_stats ifb0 "下载"
        else
            printf "${RED}❌ 下载队列 (ifb0) 未配置${NC}\n\n"
        fi
        
        # 显示建议
        printf "${BLUE}══════════════════════════════════════════════════════════════${NC}\n"
        printf "${BLUE}  优化建议${NC}\n"
        printf "${BLUE}══════════════════════════════════════════════════════════════${NC}\n"
        printf "  🔹 ${GREEN}绿色${NC}: 运行良好，无需调整\n"
        printf "  🔸 ${YELLOW}黄色${NC}: 轻微问题，可考虑微调\n" 
        printf "  🔴 ${RED}红色${NC}: 需要调整带宽或算法参数\n"
        printf "\n"
        printf "  ${YELLOW}按 Ctrl+C 退出监控${NC}\n"
        
        sleep 2
    done
}

# 一次性显示模式
show_once() {
    clear_screen
    printf "${GREEN}QoS 状态快照 - $(date '+%Y-%m-%d %H:%M:%S')${NC}\n\n"
    
    get_qos_stats $WAN_IF "上传"
    
    if ip link show ifb0 >/dev/null 2>&1; then
        get_qos_stats ifb0 "下载"
    fi
}

# 显示帮助信息
show_help() {
    echo "OpenWrt fq_codel QoS 完整管理脚本"
    echo ""
    echo "用法: $0 [命令] [选项]"
    echo ""
    echo "命令:"
    echo "  start        - 启用QoS配置"
    echo "  stop         - 停止QoS配置"
    echo "  restart      - 重启QoS配置"
    echo "  check        - 快速状态检查"
    echo "  monitor      - 实时监控模式（保留历史数据）"
    echo "  monitor reset- 实时监控模式（重置统计数据）"
    echo "  reset        - 重置统计数据"
    echo "  once         - 显示一次状态快照"
    echo "  help         - 显示此帮助信息"
    echo ""
    echo "示例:"
    echo "  $0 start     - 启用QoS"
    echo "  $0 monitor   - 启动实时监控（保留历史数据）"
    echo "  $0 monitor reset - 启动实时监控（先重置统计数据）"
    echo "  $0 check     - 快速检查状态"
    echo "  $0 stop      - 停止QoS"
}

# 参数处理
case "$1" in
    "start")
        start_qos
        echo ""
        echo "📊 快速命令:"
        echo "  实时监控: $0 monitor"
        echo "  快速检查: $0 check"
        echo "  停止QoS:  $0 stop"
        ;;
    "stop")
        stop_qos
        ;;
    "restart")
        stop_qos
        echo "等待1秒..."
        sleep 1
        start_qos
        ;;
    "check")
        check_qos
        echo ""
        printf "快速命令:\n"
        printf "  详细监控: $0 monitor\n"
        printf "  停止QoS:  $0 stop\n"
        ;;
    "monitor")
        main_monitor "$@"
        ;;
    "reset")
        reset_stats
        ;;
    "once")
        show_once
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    "")
        # 默认显示帮助信息
        show_help
        ;;
    *)
        echo "未知命令: $1"
        echo "使用 '$0 help' 查看帮助信息"
        exit 1
        ;;
esac
